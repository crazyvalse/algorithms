# 缓存

## 1. 强缓存

- 强缓存不经过服务器，协商缓存返回的状态码是 304；
- 当两类缓存同时存在时，强缓存的优先级高于协商缓存；

- HTTP1.0
  - Expires(HTTP1.0)： 为服务器端返回的数据到期时间
    - 服务器时间与客户端可能会有偏差
  - Pragma: 当值为 "no-cache" 时强制验证缓存，浏览器的表现行为跟 F5 类似
- HTTP1.1
  - Cache-Control
    - private: 客户端可以缓存
    - public: 客户端和代理服务器都可以缓存
    - max-age=t: 缓存内容将在 t 秒后失效
    - no-cache: 需要使用协商缓存来验证缓存数据
    - no-store: 所有内容都不会缓存

## 2. 协商缓存

- 协商缓存需要进行对比是否可以使用缓存。
- 浏览器第一次请求数据时，服务器会讲缓存标识与数据一起响应给客户端。
- 客户端将缓存标识保存起来
- 再次请求时，客户端会将缓存中的标识发送给服务器。

  - 若未失效，返回状态码 304。
  - 失效就请求文件

> Last-Modified 表示本地文件最后修改日期，If-Modified-Since 会将 Last-Modified 的值发送给服务器，询问服务器在该日期后资源是否有更新，有更新的话就会将新的资源发送回来，否则返回 304 状态码。

- Last-Modified: 服务器在响应请求时，会告诉浏览器资源的最后修改时间
- if-Modified-Since: 再次请求的时候，请求头会包含这个字段。服务器收到请求之后发现这个字段，会跟请求的文件做对比，如果一致就返回 304，不一致就返回一个资源体。
- if-Unmodified-Since: 与上一条相反，相同就允许下载，不相同就返回 412 Precondition failed 预处理错误

- 如果一个资源被修改了，但是内容没有变化，那么光靠 Last-Modified 字段也会带来负面作用，因此可以使用 Etag

> ETag 类似于文件指纹，If-None-Match 会将当前 ETag 发送给服务器，询问该资源 ETag 是否变动，有变动的话就将新的资源发送回来。并且 ETag优先级比 Last-Modified 高。

- Etag：服务器响应请求时，通过此字段告诉浏览器当前资源在服务器上的唯一标识。
- If-Match: 条件请求携带上一次请求中资源的 Etag，服务器根据这个字段判断文件是否有新的修改。
- If-None-Match: 再次请求服务器时，浏览器的请求报文头部会包含此字段。服务器接收到次报文后发现 If-None-Match 则与被请求资源的唯一标识进行对比
  - 不同，说明资源被改动过，则响应整个资源内容，返回状态码 200。
  - 相同，说明资源无心修改，则响应 header，浏览器直接从缓存中获取数据信息。返回状态码 304.

> 由于 Etag 的计算是使用算法来得出的，而算法会占用服务端计算的资源，所有服务端的资源都是宝贵的，所以就很少使用 Etag 了。

